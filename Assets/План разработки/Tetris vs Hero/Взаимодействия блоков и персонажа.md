# ⚔️ Взаимодействия блоков и персонажа

Центральная механика игры. Реализована в `BlockInteraction.cs` и `GameManager.cs`.

---

## Что работает

### Удар персонажа → блок

```
J / L нажата
  └─ OnAttack(cx + dir, cy, dir)
       └─ BlockInteraction.HandleAttack
            ├─ ячейки (x, cy) и (x, cy+1)
            ├─ IsWeak → DamageCell(x, y)
            │    └─ если HP = 0 → ячейка пуста → VictoryModel.AddDestroyedBlocks(1)
            └─ !IsWeak → _character.PlayHitStrong()  ← анимация отдачи
```

### Очистка линий → очки персонажа

```
TetrisBoard.ClearLines()
  └─ OnLinesCleared(count)
       └─ BlockInteraction.HandleLinesCleared
            └─ AddDestroyedBlocks(boardWidth × count)
```

> [!tip] Конфликт интересов
> Тетрис, очищая линии, **помогает персонажу** набирать очки.
> Это заставляет тетрис-игрока думать: "заполнять или нет?"

### Crush — блок на персонажа

**При фиксации фигуры** (`OnPiecePlaced` → `CheckCrush`):
```
WorldToCell(character.position) → (cx, cy)
IsCellOccupied(cx, cy) || IsCellOccupied(cx, cy+1) → TriggerTetrisWin
```

**Во время падения** (`GameManager.Update` → `CheckActivePieceCrush`):
```
Current.GetCells() → проверить пересечение с (cx, cy) и (cx, cy+1)
```

### Активная фигура как препятствие

```
Board.ExtraOccupied = (x, y) => TetrisController.IsActivePieceCell(x, y)
```

`CharacterController2D.MoveAndCollide` вызывает `IsCellOccupied` → персонаж
не проходит сквозь падающую фигуру.

---

## HP-визуал слабых блоков

`BoardRenderer.RefreshCell` затемняет цвет пропорционально урону:

| HP / MaxHP | Визуал |
|-----------|--------|
| 100% | Обычный цвет (чуть осветлён) |
| 50% | Цвет ×50% затемнён к чёрному |
| 0% | Ячейка пуста (пустой цвет) |

Формула: `c = Lerp(c, black, (1 − HP/MaxHP) × 0.5f)`

---

## Цепочка вызовов (полная)

```
[Тетрис] Space → HardDrop
  └─ LockPiece
       ├─ Board.PlacePiece   → OnPiecePlaced → CheckCrush
       ├─ Board.ClearLines   → OnLinesCleared → HandleLinesCleared → AddDestroyedBlocks
       └─ SpawnPiece → если нет места → GameOver → TriggerTetrisWin (фоллбэк)

[Персонаж] J → HandleAttack
  └─ OnAttack(cx-1, cy, -1)
       └─ HandleAttack
            ├─ IsWeak  → DamageCell → AddDestroyedBlocks → [если порог] OnCharacterWin
            └─ !IsWeak → PlayHitStrong
```

---

## TODO

> [!todo]
> - [x] Активная фигура блокирует персонажа (`ExtraOccupied`)
> - [x] Crush во время падения (`CheckActivePieceCrush` в Update)
> - [x] HP-визуал (`CellData.MaxHP` + `BoardRenderer`)
> - [x] Фидбек удара по сильному блоку (`PlayHitStrong`)
> - [x] Misleading комментарий в `GameManager` исправлен
> - [ ] Проверить hitbox crush на граничных случаях (коллайдер на границе ячейки)

---

← [[Tetris vs Hero]] · [[Концепция]] · [[Типы блоков]] · [[TetrisBoard — API]] · → [[Архитектура MVC]] · [[Статус реализации]]
